---
title: "Improving power of single cell eQTL with factorization"
author: "Lifan Liang"
date: "2025-01-14"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Simple simulation

```{r,setup=T, echo=F}
sim_factor <- function(alpha=0.2, beta1=0.4, beta2=0.3, eps1=0.2, eps2=0.4){
  res <- numeric(9L)
  names(res) <- c("beta.Z","score.Z","p.Z",
                  "beta1.x","score1.x","p1.x",
                  "beta2.x","score2.x","p2.x")
  x = rnorm(100,sd=1)
  Z = alpha*x + rnorm(100,sd=eps1)
  y1 = beta1*Z + rnorm(100,sd=eps2)
  y2 = beta2*Z + rnorm(100,sd=eps2)
  
  res[c("beta.Z","score.Z","p.Z")] <- summary(lm(Z~x))$coefficients[2,c(1,3,4)]
  
  res[c("beta1.x","score1.x","p1.x")] <- summary(lm(y1~x))$coefficients[2,c(1,3,4)]
  res[c("beta2.x","score2.x","p2.x")] <- summary(lm(y2~x))$coefficients[2,c(1,3,4)]
  
  res
}
```

We generated data with one latent factor $Z$ that affects two traits, $Y_1$ and $Y_2$. The generative process is as follow:

$$
X \sim Normal(0,1)
\\
\epsilon_0 \sim Normal(0,\sigma_0^2)
\\
\\
\epsilon_1 \sim Normal(0,\sigma_1^2)
\\
Z = \alpha X + \epsilon_0
\\
Y_1 = \beta_1 Z + \epsilon_1
\\
Y_2 = \beta_2 Z + \epsilon_1
$$

Most parameters are fixed during simulation. We set $\alpha = 0.2$, $\beta_1 = 0.3$, $\beta_2 = 0.2$, and $\sigma_1 = 0.4$. We compared the t score and P values of regressing X against Y versus X against X.

```{r,echo=F}
library(ggplot2)
par(mfrow=c(1,3))
ress <- do.call(rbind, lapply(1:100,sim_factor,eps1=0.05))
plot(abs(ress[,"score1.x"]), abs(ress[,"score.Z"]), pch=20,
     ylim=c(0,55), xlim=c(0,5),col=3,main="sigma0=0.05",
     ylab="t score for Z~X", xlab="t score for Y~X")
points(abs(ress[,"score2.x"]), abs(ress[,"score.Z"]), pch=20,col=2)
lines(x=c(-4,6),y=c(-4,6),col=1)

ress <- do.call(rbind, lapply(1:100,sim_factor,eps1=0.2))
plot(abs(ress[,"score1.x"]), abs(ress[,"score.Z"]), main="sigma0=0.2", pch=20,
     ylim=c(0,15), xlim=c(0,5),col=3,ylab="t score for Z~X", xlab="t score for Y~X")
points(abs(ress[,"score2.x"]), abs(ress[,"score.Z"]), pch=20,col=2)
lines(x=c(-4,6),y=c(-4,6),col=1)


ress <- do.call(rbind, lapply(1:100,sim_factor,eps1=0.4))
plot(abs(ress[,"score1.x"]), abs(ress[,"score.Z"]),main="sigma0=0.4", pch=20,
     ylim=c(0,10), xlim=c(0,5),col=3,ylab="t score for Z~X", xlab="t score for Y~X")
points(abs(ress[,"score2.x"]), abs(ress[,"score.Z"]), pch=20,col=2)
lines(x=c(-4,6),y=c(-4,6),col=1)

#legend(col=c(3,2),legend = c("Y1~X","Y2~X"))
```


### Theoretical power gain

In fact, we can directly derive the power gain from this simple simulation scenario. For instance, let's focus on $Y_1$, we have:

$$
Y_1 = \alpha \beta_1 X + \epsilon_1 + \beta_1 \epsilon_0
$$

Hence, we can derive the expected t score of X:

$$
Tscore(Y_1 \sim X) ^2= \dfrac{N\alpha^2 \beta_1^2}{\sigma_1^2+\beta_1^2\sigma_0^2}
$$
On the other hand,  we have:
$$
Tscore(Z \sim X)^2 = \dfrac{N\alpha^2}{\sigma_0^2}
$$
So the expected ratio between the two should be:
$$
(\dfrac{Tscore(Z \sim X)}{Tscore(Y_1 \sim X)})^2 = 1 + (\dfrac{\sigma_1}{\sigma_0 \beta_1})^2
$$

Therefore, we will always gain power if we know the latent factor as ground truth. 




